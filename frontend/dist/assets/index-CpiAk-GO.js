(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function e(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=e(r);fetch(r.href,a)}})();const c={user:JSON.parse(localStorage.getItem("user")||"null"),token:localStorage.getItem("token")||null,socket:null};function B(){if(console.log("🏠 Page Home affichée."),c.user)return g(new Event("click"),"/dashboard"),document.createElement("div");g(new Event("click"),"/login");const t=document.createElement("div");t.className="flex flex-col items-center min-h-screen bg-black text-white p-8";const o=document.createElement("h1");o.innerText="🚀 Bienvenue sur Ft Transcendence",o.className="text-4xl font-bold text-purple-400";const e=document.createElement("button");return e.innerText="🔑 Se Connecter",e.className="mt-4 px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg shadow-md transition-all",e.onclick=n=>g(n,"/login"),t.append(o,e),t}function K(t,o){c.token=t,c.user=o,localStorage.setItem("token",t),localStorage.setItem("user",JSON.stringify(o))}function P(){const t=localStorage.getItem("token"),o=localStorage.getItem("user");t&&o?(c.token=t,c.user=JSON.parse(o),console.log("🔓 Données utilisateur restaurées :",c.user),L(c.user.id,e=>{console.log("📩 Message WebSocket reçu :",e)})):(console.log("❌ Aucun utilisateur trouvé, redirection vers login."),R())}function A(){return!!c.token}async function R(){console.log("🔴 Déconnexion en cours...");try{await fetch(`http://localhost:3000/users/${c.user.id}/status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"offline"})}),console.log("✅ Serveur mis à jour : utilisateur offline."),c.socket}catch(t){console.error("❌ Erreur lors de la déconnexion :",t)}c.user=null,c.token=null,localStorage.removeItem("token"),localStorage.removeItem("user"),console.log("✅ Déconnexion réussie. Redirection vers /login..."),setTimeout(()=>g(new Event("click"),"/login"),100)}async function V(t,o){try{const e=await fetch("http://localhost:3000/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:o})}),n=await e.json();if(!e.ok)throw new Error(n.error||"Erreur de connexion");K(n.token,n.user),L(n.user.id,r=>{console.log("📩 Message WebSocket reçu :",r)}),window.location.href="/dashboard"}catch(e){throw console.error("❌ Échec de la connexion :",e),e}}async function Q(t,o,e){try{const n=await fetch("http://localhost:3000/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:o,password:e})});if(!n.ok){const r=await n.json();throw new Error(r.message||"Erreur d'inscription")}return await n.json()}catch(n){throw console.error("❌ Échec de l'inscription :",n),n}}function L(t,o){if(!t)return;let e=new WebSocket(`ws://localhost:3000/ws?userId=${t}`);e.onopen=()=>{console.log("✅ Connecté au WebSocket en tant que",t)},e.onclose=()=>{console.log("❌ Déconnecté du WebSocket. Reconnexion...")},e.onerror=n=>{console.error("⚠️ Erreur WebSocket :",n)},e.onmessage=n=>{const r=JSON.parse(n.data);console.log("📩 Message WebSocket reçu :",r),o(r)}}function U(){const t=document.createElement("nav");t.className="fixed top-4 left-0 w-full flex justify-center z-50";const o=document.createElement("div");o.className="bg-gray-900 bg-opacity-70 px-8 py-3 rounded-full flex items-center gap-6 shadow-md border border-gray-800";const e=document.createElement("h1");e.innerText="🚀 Ft Transcendence",e.className="text-lg font-bold text-purple-300 cursor-pointer transition-transform transform hover:scale-105",e.onclick=l=>g(l,"/");const n=document.createElement("div");n.className="flex gap-3";const r=document.createElement("button");r.innerText="🏠 Dashboard",r.className="px-5 py-2 bg-gray-700 text-gray-300 border border-gray-600 rounded-lg transition-all transform hover:scale-105 hover:bg-gray-600",r.onclick=l=>g(l,"/dashboard");const a=document.createElement("button");a.innerText="👤 Profil",a.className="px-5 py-2 bg-gray-700 text-gray-300 border border-gray-600 rounded-lg transition-all transform hover:scale-105 hover:bg-gray-600",a.onclick=l=>g(l,"/profile");const s=document.createElement("button");return s.innerText="🚪 Déconnexion",s.className="px-5 py-2 bg-gray-800 text-red-400 border border-red-500 rounded-lg transition-all transform hover:scale-105 hover:bg-gray-700",s.onclick=async()=>{await R()},n.append(r,a,s),o.append(e,n),t.appendChild(o),t}function N(t){const o=document.createElement("div");o.className="min-h-screen flex flex-col bg-gray-900 text-white",o.appendChild(U());const e=document.createElement("div");return e.className="flex flex-col items-center justify-center min-h-screen mt-16 px-4 w-full",e.appendChild(t),o.appendChild(e),o}const _=1e3,$=500,x={x:20,y:$/2-50,width:10,height:100},y={x:_-30,y:$/2-50,width:10,height:100},v={x:_/2,y:$/2,radius:10};let X=0,Y=0;function Z(){return{score1:X,score2:Y}}function q(t,o){const e=t.getContext("2d");function n(){if(!e)return;e.clearRect(0,0,t.width,t.height);const{score1:r,score2:a}=Z();e.fillStyle="white",e.font="32px Arial",e.fillText(r.toString(),t.width/4,50),e.fillText(a.toString(),t.width*3/4,50),e.fillRect(x.x,x.y,x.width,x.height),e.fillRect(y.x,y.y,y.width,y.height),e.beginPath(),e.arc(v.x,v.y,v.radius,0,Math.PI*2),e.fill(),requestAnimationFrame(n)}n()}function z(t){t.onmessage=o=>{const e=JSON.parse(o.data);if(console.log("📥 Mise à jour reçue :",e),e.type==="update"){v.x=e.ball.x,v.y=e.ball.y;for(const n in e.players)n===localStorage.getItem("userId")?x.y=e.players[n].y:y.y=e.players[n].y}}}const O={};let E=null;function F(t,o,e,n){E=n,document.addEventListener("keydown",a=>{["ArrowUp","ArrowDown","z","s"].includes(a.key)&&(a.preventDefault(),O[a.key]=!0,J(a.key,!0))}),document.addEventListener("keyup",a=>{["ArrowUp","ArrowDown","z","s"].includes(a.key)&&(O[a.key]=!1,J(a.key,!1))});function r(){requestAnimationFrame(r)}r()}function J(t,o){E&&E.readyState===WebSocket.OPEN&&E.send(JSON.stringify({type:"move",key:t,state:o}))}function ee(){const t=document.createElement("div");t.className="flex flex-col items-center justify-center w-full h-screen bg-gray-900 text-white p-4";const o=document.createElement("h1");o.className="text-4xl font-bold mb-6",o.innerText="🏓 Recherche d'un match...";const e=document.createElement("div");e.className="relative flex flex-col items-center justify-center w-full max-w-4xl h-[600px] bg-gray-800 border-4 border-gray-700 rounded-lg shadow-lg";const n=document.createElement("canvas");n.width=1e3,n.height=500,n.className="w-full h-auto max-w-full border-4 border-white rounded-md",e.appendChild(n),t.appendChild(o),t.appendChild(e);const r=localStorage.getItem("userId"),a=localStorage.getItem("matchId");if(console.log("🔍 Tentative de connexion WebSocket avec :",{userId:r,matchId:a}),!r||!a)return console.error("❌ userId ou matchId manquant, impossible de rejoindre la partie."),N(t);let s=0;const l=5;let i=null;function u(){if(s>=l){console.error("❌ Trop de tentatives de connexion WebSocket. Arrêt.");return}i=new WebSocket(`ws://localhost:3000/ws?userId=${r}&matchId=${a}`),i.onopen=()=>{console.log("✅ Connecté au serveur WebSocket en tant que :",r),s=0},i.onmessage=d=>{console.log("📥 Message WebSocket reçu :",JSON.parse(d.data))},i.onclose=()=>{console.warn("⚠️ Déconnecté du WebSocket. Tentative de reconnexion..."),s++,setTimeout(u,2e3)},i.onerror=d=>{console.error("❌ Erreur WebSocket:",d)},setTimeout(()=>{i?(q(n),F(x,y,n.height,i),z(i)):console.error("❌ WebSocket non initialisé !")},500)}return u(),N(t)}let M=[],H=0;async function te(){const t=Date.now();if(M.length>0&&t-H<1e4)return console.log("🔹 Utilisation du cache pour la liste des utilisateurs"),M;console.log("🔹 Envoi de la requête GET vers /users/all...");try{const o=await fetch("http://localhost:3000/users/all",{method:"GET",headers:{"Content-Type":"application/json"}});if(!o.ok)throw new Error(`Erreur HTTP : ${o.status}`);const e=await o.json();return M=e,H=t,console.log("✅ Utilisateurs reçus :",e),e}catch(o){return console.error("❌ Erreur lors de la récupération des utilisateurs :",o),[]}}async function ne(t,o){try{const e=await fetch("/api/users/update",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,email:o})});if(!e.ok)throw new Error(`Erreur HTTP : ${e.status}`);return console.log(`✅ Utilisateur ${t} mis à jour`),!0}catch(e){return console.error("❌ Erreur lors de la mise à jour de l'utilisateur :",e),!1}}function oe(){if(!c.user)return window.location.href="/login",document.createElement("div");const t=document.createElement("div");t.className="flex flex-col items-start p-6 bg-gray-900 text-white rounded-xl shadow-lg w-96 mt-6 ml-24 border border-gray-700";const o=document.createElement("h2");o.innerText="Profile Management",o.className="text-3xl font-bold mb-4 text-left text-blue-400";const e=document.createElement("img");e.src=c.user.avatar||"default-avatar.png",e.className="w-24 h-24 rounded-full border-2 border-blue-400 mb-3";const n=document.createElement("input");n.type="text",n.value=c.user.username,n.className="input-style";const r=document.createElement("input");r.type="email",r.value=c.user.email,r.className="input-style";const a=document.createElement("button");a.innerText="Save",a.className="btn-primary",a.onclick=async()=>{await ne(n.value,r.value)?(c.user.username=n.value,c.user.email=r.value,alert("Profile updated!")):alert("Error updating profile")};const s=document.createElement("div");s.className="absolute top-6 left-6 w-12 h-12 bg-gray-700 rounded-lg flex items-center justify-center cursor-pointer text-white text-xl transition duration-300 transform hover:scale-110 hover:bg-gray-600 shadow-lg",s.innerHTML='<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path></svg>',s.onclick=()=>{window.history.back()};const l=document.createElement("div");l.className="grid grid-cols-12 gap-4 w-full h-screen p-4";const i=document.createElement("div");i.className="col-span-3 bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col items-center",i.append(o,e,n,r,a);const u=document.createElement("div");u.className="col-span-6 bg-gray-800 rounded-lg shadow-lg p-4 flex items-center justify-center",u.innerText="Leaderboard";const d=document.createElement("div");d.className="col-span-3 bg-gray-800 rounded-lg shadow-lg p-4 flex flex-col";const m=document.createElement("h3");m.innerText="Matches History",m.className="text-lg font-bold text-white mb-2";const h=document.createElement("div");h.className="flex flex-col gap-2";async function w(){try{const f=await(await fetch(`/api/matches?userId=${c.user.id}`)).json();console.log("Matches received:",f),f.forEach(p=>{console.log(`Appending match: ${p.player1_name} vs ${p.player2_name} - Winner: ${p.winner_name}`);const C=document.createElement("div"),G=p.winner_name===c.user.username;C.className=`p-2 rounded-lg text-white text-sm flex items-center space-x-2 ${G?"bg-blue-600":"bg-red-600"}`;const I=document.createElement("img");I.src=p.player1_avatar||"default-avatar.png",I.className="w-8 h-8 rounded-full border-2 border-white";const W=document.createElement("img");W.src=p.player2_avatar||"default-avatar.png",W.className="w-8 h-8 rounded-full border-2 border-white";const D=document.createElement("span");D.innerText=`${new Date(p.played_at).toLocaleDateString()} - ${p.player1_name} VS ${p.player2_name} → Winner: ${p.winner_name}`,C.append(I,D,W),h.appendChild(C)})}catch(b){console.error("Error fetching match history:",b)}}w(),d.append(m,h);const k=document.createElement("div");k.className="col-span-12 bg-gray-800 rounded-lg shadow-lg p-4 flex items-center justify-center",k.innerText="Stats",l.append(i,u,d,k);const S=document.createElement("div");S.className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0";for(let b=0;b<100;b++){const f=document.createElement("div");f.className="absolute bg-white rounded-full opacity-75 animate-twinkle";const p=Math.random()*3+"px";f.style.width=p,f.style.height=p,f.style.top=Math.random()*100+"vh",f.style.left=Math.random()*100+"vw",f.style.animationDuration=Math.random()*3+2+"s",S.appendChild(f)}const T=document.createElement("div");return T.className="relative w-full h-screen flex flex-col",T.append(S,s,l),T}function j(){const t=document.createElement("form");t.className="flex flex-col items-center p-6 bg-gray-900 text-white rounded-xl shadow-lg w-96 mx-auto mt-20 border border-gray-700";const o=document.createElement("h2");o.innerText="Connexion",o.className="text-3xl font-bold mb-4 text-center text-blue-400";const e=document.createElement("input");e.type="text",e.placeholder="Nom d'utilisateur",e.className="input-style";const n=document.createElement("input");n.type="password",n.placeholder="Mot de passe",n.className="input-style";const r=document.createElement("p");r.className="text-red-500 text-sm mt-2 hidden";const a=document.createElement("button");a.innerText="Se connecter",a.className="btn-primary",a.onclick=async l=>{l.preventDefault(),r.classList.add("hidden");try{await V(e.value,n.value),g(new Event("click"),"/register")}catch(i){r.innerText="Erreur : "+i.message,r.classList.remove("hidden")}};const s=document.createElement("a");return s.innerText="Pas encore inscrit ?",s.className="text-blue-400 hover:underline mt-3 cursor-pointer",s.onclick=l=>{l.preventDefault(),g(new Event("click"),"/register")},t.append(o,e,n,r,a,s),t}function re(){const t=document.createElement("form");t.className="flex flex-col items-center p-6 bg-gray-900 text-white rounded-xl shadow-lg w-96 mx-auto mt-20 border border-gray-700";const o=document.createElement("h2");o.innerText="Inscription",o.className="text-3xl font-bold mb-4 text-center text-blue-400";const e=document.createElement("input");e.type="text",e.placeholder="Nom d'utilisateur",e.className="input-style";const n=document.createElement("input");n.type="email",n.placeholder="Email",n.className="input-style";const r=document.createElement("input");r.type="password",r.placeholder="Mot de passe",r.className="input-style";const a=document.createElement("p");a.className="text-red-500 text-sm mt-2 hidden";const s=document.createElement("button");return s.innerText="S'inscrire",s.className="btn-primary",s.onclick=async l=>{l.preventDefault(),a.classList.add("hidden");try{await Q(e.value,n.value,r.value),window.location.href="/login"}catch(i){a.innerText="Erreur : "+i.message,a.classList.remove("hidden")}},t.append(o,e,n,r,a,s),t}function ae(){if(console.log("🖥 Rendu du dashboard..."),!c.user)return console.log("❌ Utilisateur non connecté. Redirection..."),setTimeout(()=>{c.user||g(new Event("click"),"/login")},200),document.createElement("div");console.log("✅ Utilisateur connecté :",c.user.username);const t=document.createElement("div");t.className="flex flex-col items-center min-h-screen bg-black text-white relative overflow-hidden",t.innerHTML=`
        <div class="absolute inset-0 bg-gradient-to-b from-black via-gray-900 to-black"></div>
        <div class="absolute inset-0 bg-stars animate-twinkling"></div>
    `;const o=U();o.className="relative z-20 w-full",t.appendChild(o);const e=document.createElement("div");e.className="relative z-10 flex flex-col items-center p-8 w-full max-w-3xl mx-auto text-center";const n=document.createElement("h2");n.innerText=`🌌 Bienvenue, ${c.user.username} !`,n.className="text-4xl font-bold text-purple-400 drop-shadow-md";const r=document.createElement("div");r.className="mt-8 bg-gray-800 bg-opacity-50 p-4 rounded-lg shadow-lg w-full max-w-md";const a=document.createElement("h3");a.innerText="🌠 Joueurs en ligne",a.className="text-xl text-green-300 mb-2";const s=document.createElement("ul");s.className="text-white text-lg space-y-2",r.append(a,s),e.append(n,r),t.appendChild(e);async function l(){const u=await te();s.innerHTML="",u.sort((d,m)=>d.status==="online"?-1:1),u.forEach(d=>{const m=document.createElement("li");m.id=`user-${d.id}`,m.className=`p-2 rounded ${d.status==="online"?"text-green-400":"text-red-400"}`,m.innerText=`${d.username} ${d.status==="online"?"🟢":"🔴"}`,s.appendChild(m)})}function i(u,d){const m=document.getElementById(`user-${u}`);m&&(m.className=`p-2 rounded ${d==="online"?"text-green-400":"text-red-400"}`,m.innerText=`${m.innerText.split(" ")[0]} ${d==="online"?"🟢":"🔴"}`,d==="online"&&s.prepend(m))}return L(String(c.user.id),u=>{u.type==="user_status"&&i(u.userId,u.status)}),l(),t}function se(){const t=document.createElement("div");t.className="flex flex-col items-center justify-center w-full h-screen bg-gray-900 text-white p-4";const o=document.createElement("h1");o.className="text-4xl font-bold mb-6",o.innerText="🏓 Pong - Match en cours";const e=document.createElement("div");e.className="relative flex flex-col items-center justify-center w-full max-w-4xl h-[600px] bg-gray-800 border-4 border-gray-700 rounded-lg shadow-lg";const n=document.createElement("canvas");n.width=1e3,n.height=500,n.className="w-full h-auto max-w-full border-4 border-white rounded-md",e.appendChild(n);const r=document.createElement("div");r.className="flex justify-between w-full px-6 py-2 bg-gray-700 text-lg font-semibold rounded-b-lg";const a=document.createElement("div");a.innerText="👤 Joueur 1";const s=document.createElement("div");s.innerText="👤 Joueur 2",r.appendChild(a),r.appendChild(s),t.appendChild(o),t.appendChild(e),t.appendChild(r);const l=localStorage.getItem("userId"),i=localStorage.getItem("matchId");if(console.log("🔍 Tentative de connexion WebSocket avec :",{userId:l,matchId:i}),!l||!i)return console.error("❌ userId ou matchId manquant, impossible de rejoindre la partie."),N(t);let u=0;const d=5;function m(){if(u>=d){console.error("❌ Trop de tentatives de connexion WebSocket. Arrêt.");return}const h=new WebSocket(`ws://localhost:3000/ws?userId=${l}&matchId=${i}`);h.onopen=()=>{console.log("✅ Connecté au serveur WebSocket en tant que :",l),u=0},h.onmessage=w=>{console.log("📥 Message WebSocket reçu :",JSON.parse(w.data))},h.onclose=()=>{console.warn("⚠️ Déconnecté du WebSocket. Tentative de reconnexion..."),u++,setTimeout(m,2e3)},h.onerror=w=>{console.error("❌ Erreur WebSocket:",w)},setTimeout(()=>{q(n),F(x,y,n.height,h),z(h)},500)}return m(),N(t)}const ce={"/":B,"/game":ee,"/profile":async()=>A()?await oe():await j(),"/login":j,"/dashboard":async()=>A()?await ae():await j(),"/match":se,"/register":re};function g(t,o){t.preventDefault(),window.history.pushState({},"",o),window.dispatchEvent(new Event("popstate"))}window.navigateTo=g;function le(){const t=document.getElementById("app");if(!t)return;const o=async()=>{setTimeout(async()=>{const e=window.location.pathname,n=ce[e]||B;t.innerHTML="",t.appendChild(await n())},100)};window.addEventListener("popstate",o),o()}document.addEventListener("DOMContentLoaded",()=>{console.log("🔹 Chargement de l'application..."),typeof P=="function"?(P(),console.log("✅ Données utilisateur chargées !")):console.warn("⚠️ `loadAuthData` est introuvable !"),le()});
